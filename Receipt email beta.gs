{"files":[{"id":"adfe77ca-1107-4d00-b07b-e0a4af08e69a","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Bangkok\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"c19d3cf2-7eab-4cd0-b73f-1ff88c394784","name":"auto_email_invoice","type":"server_js","source":"///////////////////////////////////////////////////////////////////////////////////////////////\n// BEGIN EDITS ////////////////////////////////////////////////////////////////////////////////\n\nconst TEMPLATE_FILE_ID \u003d \u00271S6hG728IeIAo2r-6xJ3Jnei9l-pFx1asu9nIhQLGitY\u0027;\nconst DESTINATION_FOLDER_ID \u003d \u00271W1RkGnjWnK1TeKPGuqJWckEVcnsEb5Ws\u0027;\nconst CURRENCY_SIGN \u003d \u0027THB \u0027;\n\n// END EDITSasdf //////////////////////////////////////////////////////////////////////////////////\n///////////////////////////////////////////////////////////////////////////////////////////////\n// WARNING: EDITING ANYTHING BELOW THIS LINE WILL CHANGE THE BEHAVIOR OF THE SCRIPT. //////////\n// DO SO AT YOUR OWN RISK.//// ////////////////////////////////////////////////////////////////\n// ----------------------------------------------------------------------------------------- //\n\n// Converts a float to a string value in the desired currency format\nfunction toCurrency(num) {\n    var fmt \u003d Number(num).toFixed(2);\n    // Split the string into integer and decimal parts\n    var parts \u003d fmt.split(\u0027.\u0027);\n\n    // Add commas to the integer part\n    parts[0] \u003d parts[0].replace(/\\B(?\u003d(\\d{3})+(?!\\d))/g, \u0027,\u0027);\n\n    // Rejoin the parts and add the currency sign\n    return `${CURRENCY_SIGN}${parts.join(\u0027.\u0027)}`;\n}\n\n// Format datetimes to: YYYY-MM-DD\nfunction toDateFmt(dt_string) {\n  var millis \u003d Date.parse(dt_string);\n  var date \u003d new Date(millis);\n  var year \u003d date.getFullYear();\n  var month \u003d (\"0\" + (date.getMonth() + 1)).slice(-2);\n  var day \u003d (\"0\" + date.getDate()).slice(-2);\n\n  // Return the date in YYYY-mm-dd format\n  return `${year}-${month}-${day}`;\n}\n\n\n// Parse and extract the data submitted through the form.\nfunction parseFormData(values, header) {\n    // Set temporary variables to hold prices and data.\n    var subtotal \u003d 0;\n    var deposit \u003d 0;\n    var response_data \u003d {};\n\n    // Iterate through all of our response data and add the keys (headers)\n    // and values (data) to the response dictionary object.\n    for (var i \u003d 0; i \u003c values.length; i++) {\n      // Extract the key and value\n      var key \u003d header[i];\n      var value \u003d values[i];\n\n      // If we have a price, add it to the running subtotal and format it to the\n      // desired currency.\n      if (key.toLowerCase().includes(\"price\") \u0026\u0026 value \u0026\u0026 value !\u003d\u003d 0) {\n        response_data[key] \u003d value; // Add only existing prices\n        subtotal +\u003d value;\n        value \u003d toCurrency(value);\n\n    \n      // If there is a deposit, track it so we can adjust the total later and\n      // format it to the desired currency.\n      } else if (key.toLowerCase().includes(\"deposit\")) {\n        deposit +\u003d value;\n        value \u003d toCurrency(value);\n      \n      // Format dates\n      } else if (key.toLowerCase().includes(\"date\")) {\n        value \u003d toDateFmt(value);\n      }\n\n      // Add the key/value data pair to the response dictionary.\n      response_data[key] \u003d value;\n    }\n\n    // Once all data is added, we\u0027ll adjust the subtotal and total\n    response_data[\"sub_total\"] \u003d toCurrency(subtotal);\n    response_data[\"total\"] \u003d toCurrency(subtotal - deposit);\n\n    return response_data;\n}\n\n// Helper function to inject data into the template\nfunction populateTemplate(document, response_data) {\n\n    // Get the document header and body (which contains the text we\u0027ll be replacing).\n    var document_header \u003d document.getHeader();\n    var document_body \u003d document.getBody();\n\n    // Replace variables in the header\n    for (var key in response_data) {\n      var match_text \u003d `{{${key}}}`;\n      var value \u003d response_data[key];\n\n      // Replace our template with the final values\n      document_header.replaceText(match_text, value);\n      document_body.replaceText(match_text, value);\n    \n    }\n}\n\nfunction sendDocumentByEmail(documentId, emailAddress,recipientPreFix,recipientFirstName,recipientLastName) {\n  var subject \u003d \u0027Mom please let me go - ใบเสร็จรับเงิน\u0027;\n\n  // Open the Google Docs document using its ID\n  var doc \u003d DocumentApp.openById(documentId);\n\n  // Convert the Google Docs document to PDF\n  var pdfBlob \u003d doc.getAs(MimeType.PDF);\n\n  //getAs(\u0027application/pdf\u0027)\n  //var pdfBlob \u003d DocumentApp.openById(document.getId()).getAs(MimeType.PDF);;\n  var message \u003d \u0027เรียน \u0027+ recipientPreFix+\u0027 \u0027+recipientFirstName+\u0027 \u0027+recipientLastName+ \u0027\\n\u0027+\u0027\\tใบเสร็จรับชำระเงินค่ะ ไว้ไปสนุกด้วยกันในทริปน้า\u0027+\u0027\\n\\n\u0027+\u0027ขอบคุณค่ะ\u0027+\u0027\\n\\n\u0027+\u0027ติดตามข่าวสารอัพเดทกิจกรรม หรือทริปต่างๆได้ที่\u0027+\u0027\\n\u0027+\u0027Facebook Page : Mom Please,Let Me go\u0027+\u0027\\n\u0027+\u0027Line Official : @mompleaseletmego (มี @)\u0027;\n\n  var picture1 \u003d DriveApp.getFileById(\u00271Q2I5sHDIUdgoDi6JLbmDyKyhMR-uCNyP\u0027); //public with link\n  var inlineImages \u003d {};\n  inlineImages[picture1.getId()] \u003d picture1.getBlob();\n\n  // HTML body with logo embedded\n  var htmlBody \u003d \n    \u0027\u003cp\u003eเรียน \u0027 + recipientPreFix + \u0027 \u0027 + recipientFirstName + \u0027 \u0027 + recipientLastName + \u0027,\u003c/p\u003e\u0027 +\n    \u0027\u003cp\u003e\u0026nbsp;\u0026nbsp;\u0026nbsp;\u0026nbsp;ใบเสร็จรับชำระเงินค่ะ ไว้ไปสนุกด้วยกันในทริปน้า\u003c/p\u003e\u0027 +\n    \u0027\u003cp\u003eขอบคุณค่ะ\u003c/p\u003e\u0027 +\n    \u0027\u003cp\u003eติดตามข่าวสารอัพเดทกิจกรรม หรือทริปต่างๆได้ที่\u003c/p\u003e\u0027 +\n    \u0027\u003cp\u003eFacebook Page : Mom Please,Let Me go\u003cbr\u003e\u0027 +\n    \u0027Line Official : @mompleaseletmego (มี @)\u003c/p\u003e\u0027+\n    \u0027\u003cp\u003e\u003cimg src\u003d\"cid:\u0027 + picture1.getId() + \u0027\"\u003e\u003c/p\u003e\u0027;\n\n  // Send email with the document attached\n  GmailApp.sendEmail(emailAddress, subject, message, {\n    attachments: [pdfBlob],\n    htmlBody: htmlBody,\n    inlineImages : inlineImages\n  });\n}\n\n\n// Function to populate the template form\nfunction createDocFromForm() {\n\n  // Get active sheet and tab of our response data spreadsheet.\n  var sheet \u003d SpreadsheetApp.getActiveSheet();\n  var last_row \u003d sheet.getLastRow() - 1;\n\n  // Get the data from the spreadsheet.\n  var range \u003d sheet.getDataRange();\n \n  // Identify the most recent entry and save the data in a variable.\n  var data \u003d range.getValues()[last_row];\n  \n  // Extract the headers of the response data to automate string replacement in our template.\n  var headers \u003d range.getValues()[0];\n\n  // Parse the form data.\n  var response_data \u003d parseFormData(data, headers);\n\n  // Retreive the template file and destination folder.\n  var template_file \u003d DriveApp.getFileById(TEMPLATE_FILE_ID);\n  var target_folder \u003d DriveApp.getFolderById(DESTINATION_FOLDER_ID);\n\n  // Copy the template file so we can populate it with our data.\n  // The name of the file will be the company name and the invoice number in the format: DATE_COMPANY_NUMBER\n  var filename \u003d `${response_data[\"autonumber\"]}_${response_data[\"First Name\"]}_${response_data[\"Receipt Date\"]}`;\n  var document_copy \u003d template_file.makeCopy(filename, target_folder);\n\n  // Open the copy.\n  var document \u003d DocumentApp.openById(document_copy.getId());\n  var documentId \u003d document_copy.getId()\n\n  // Populate the template with our form responses and save the file.\n  populateTemplate(document, response_data);\n  document.saveAndClose();\n\n  // Introduce a delay (e.g., 1 minute) before sending the email\n  Utilities.sleep(30000); // half minute delay\n\n  // Get the email address,prefix,first name,last name from the form response.\n  var emailAddress \u003d response_data[\u0027Email\u0027];\n  var recipientPreFix \u003d response_data[\u0027Prefix\u0027];\n  var recipientFirstName \u003d response_data[\u0027First Name\u0027];\n  var recipientLastName \u003d response_data[\u0027Last Name\u0027];\n\n  // Send the document to the email address\n  sendDocumentByEmail(documentId, emailAddress,recipientPreFix,recipientFirstName,recipientLastName);\n    \n}"}]}